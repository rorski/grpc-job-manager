# grpc job manager

This project is a demonstration of creating a job manager service that provides an API to run arbitrary Linux processes, written in Go with [gRPC](https://grpc.io/).

It includes a worker library, gRPC API, and a client and server binary to interact with them.

## Quick Setup
* Launch a Linux instance (amd64/x86_64) and generate/attach an ssh key for it.
* Update the `INSTANCE` and `SSH_KEY` parameters in the Makefile with the info from above.
* `make all`
* `make deploy`
* ssh to the instance and unpack the tar file: `tar -xvf build.tar`
* run `server` in one terminal with `sudo ./bin/server`
* run client commands in another terminal with `./bin/client start <some command>`
* get the output with `./bin/client output <UUID>`

## Notes
This code has been tested on a [Amazon Linux 2](https://aws.amazon.com/amazon-linux-2/) t2.medium instance with Linux 5.10:
```
> uname -r
5.10.135-122.509.amzn2.x86_64
```
#### **TLS and authentication**
The server is implemented by with a minimum required TLS version of 1.3 with the default TLS 1.3 ciphers, and authentication is via mTLS (see `internal/api/server.go` for configuration details).

#### **Authorization**
There are two roles implemented, `admin` and `user`, that have different levels of access to the API. The roles are configured in the client certificate under the O (organization) field, and parsed by gRPC interceptors on the server to determine the access the client is granted.

For example, the two certificates generated by `make certs` have Subjects:
```
Subject: O=user, CN=client_user
Subject: O=admin, CN=client_admin
```
Given the four methods, each role's access is as follows:

| method | role |
| --- | --- |
| start | admin |
| stop | admin |
| status | admin, user |
| output | admin, user |

#### **cgroups**
The API server includes resource control for CPU, Memory and Disk IO per job using cgroups. This are implemented using legacy cgroups (i.e., v1), since that is the standard installation on the Amazon Linux AMI tested in this project. The server creates a cgroup per job under the relevant paths (blkio, memory, cpu). Those limits are hard coded in `cgroupParamsMap` in `worker/start.go`. (In a more production worthy version of this application that would be configurable via a config file or CLI parameters, and it would support modern v2 cgroups).

## Build and deploy
**Certificates**

This project requires client and server certificates as well as a CA to run correctly. These are generated by the `tools/make_certs.go` script. `make certs` will run that script and drop the output scripts (8 total certs/keys) into `certs/`.
```
> make certs
go run ./tools/make_certs.go
mv ./*.pem certs/
mv ./*.key certs/
> ls certs
ca.key			client_admin.key	client_user.key		server.key
ca.pem			client_admin.pem	client_user.pem		server.pem
```
**Client and server**

The client and server binaries are generated using the `client` and `server` targets. Note these are built by default using `GOOS=linux` and `GOARCH=amd64`. Because of the use of Unix specific syscalls, this will not compile or work on another OS like Mac or Windows.
```
> make client server
GOOS=linux GOARCH=amd64 go build -o ./bin/client ./cmd/client/
GOOS=linux GOARCH=amd64 go build -o ./bin/server ./cmd/server/
> ls bin
client	server
```
**Protobufs**

Generating the protobuf files is helped with the `make protobufs` command. Note you'll need the protoc / protoc-gen-go binaries to do this - see [the installation instructions](https://grpc.io/docs/protoc-installation/).
```
> make protobufs
protoc --go_out=. --go_opt=paths=import --go_opt=module=github.com/rorski/grpc-job-manager --go-grpc_out=. --go-grpc_opt=paths=import --go-grpc_opt=module=github.com/rorski/grpc-job-manager proto/job.proto
```
**Testing**

Tests are included for the the API server and the worker library. You can test them with `make test`.
```
> make test
sudo go test -race -v -timeout 30s ./worker ./internal/api
...
```
Note again these should be run on a linux OS as the syscalls in the tests won't work on Mac/Windows.

**All**

`make all` will make the protobufs, certs, client and server binaries.

**Deploy**

`make deploy` will create a tarball of the `certs/` and `bin/` directories and push it to a server as defined in the `INSTANCE` Makefile variable. Note you'll need to set the `USER` and `SSH_KEY` variables as well for this to work.
```
> make deploy
tar -cvf build.tar ./certs ./bin
a ./certs
a ./certs/client_admin.pem
a ./certs/server.key
a ./certs/server.pem
a ./certs/client_admin.key
a ./certs/ca.pem
a ./certs/client_user.pem
a ./certs/ca.key
a ./certs/client_user.key
a ./bin
a ./bin/server
a ./bin/client
scp -i sshkey build.tar ec2-user@ec2-1-2-3-4.us-west-2.compute.amazonaws.com:
build.tar                                                       100%   27MB   2.3MB/s   00:11
```
## Usage
### Server

The server binary can be run with defaults (i.e., using `certs/server.pem`, `certs/server.key`, `certs/ca.pem` and listening on `localhost:31234`).
```
> ./bin/server --help
NAME:
   server - grpc job manager server

USAGE:
   server [global options] command [command options] [arguments...]

COMMANDS:
   rexec
   help, h  Shows a list of commands or help for one command

GLOBAL OPTIONS:
   --ca value    path to CA certificate (default: "./certs/ca.pem")
   --cert value  path to certificate (default: "./certs/server.pem")
   --help, -h    show help (default: false)
   --host value  IP to listen on (default: "localhost")
   --key value   path to key (default: "./certs/server.key")
   --port value  Server port (default: 31234)
```
You can start it with defaults by just running it with sudo:
```
> sudo ./bin/server
2022/09/28 16:39:55 server listening at 127.0.0.1:31234
```
*Note* if you don't run as root / with sudo, it will likely fail with an error like the following:
```
failed starting job: rpc error: code = Unknown desc = error starting job: error running command: fork/exec /proc/self/exe: operation not permitted
```
### Client

The client binary runs with default certificates (`certs/client_admin.pem`, `certs/client_admin.key`, `certs/ca.pem`). Note that by default it uses certificates with the `admin` role, so all methods are available (start, stop, status, output).
```
> ./bin/client --help
NAME:
   client - grpc job manager client

USAGE:
   client [global options] command [command options] [arguments...]

COMMANDS:
   start    start a job
   stop     stop a job
   status   get status of a job
   output   stream output of a job
   help, h  Shows a list of commands or help for one command

GLOBAL OPTIONS:
   --ca value    path to CA certificate (default: "./certs/ca.pem")
   --cert value  path to client TLS certificate (default: "./certs/client_admin.pem")
   --help, -h    show help (default: false)
   --host value  gRPC host address (default: "localhost")
   --key value   path to client TLS key (default: "./certs/client_admin.key")
   --port value  gRPC port (default: 31234)
```

**Start job**
```
> ./bin/client start ps
Started job: "ps"
UUID: d7fe4474-2eb0-4dea-94a6-dacbdc75bf4f
```
**Stop job**
```
> ./bin/client stop d7fe4474-2eb0-4dea-94a6-dacbdc75bf4f
Stopped job: d7fe4474-2eb0-4dea-94a6-dacbdc75bf4f
```
**Status**
```
> ./bin/client status d7fe4474-2eb0-4dea-94a6-dacbdc75bf4f
Status of job: "EXITED"
```
**Output**
```
> ./bin/client output d7fe4474-2eb0-4dea-94a6-dacbdc75bf4f
  PID TTY          TIME CMD
32282 pts/1    00:00:00 sudo
32283 pts/1    00:00:00 server
32315 pts/1    00:00:00 exe
32320 pts/1    00:00:00 ps
```
**Using a custom certificate**

You can specify a different certificate through the client CLI. For instance, to use a certificate that has a `user` role, run the client like so:
```
> ./bin/client --cert ./certs/client_user.pem --key ./certs/client_user.key output d7fe4474-2eb0-4dea-94a6-dacbdc75bf4f
  PID TTY          TIME CMD
32282 pts/1    00:00:00 sudo
32283 pts/1    00:00:00 server
32315 pts/1    00:00:00 exe
32320 pts/1    00:00:00 ps

> ./bin/client --cert ./certs/client_user.pem --key ./certs/client_user.key stop d7fe4474-2eb0-4dea-94a6-dacbdc75bf4f
2022/09/28 17:03:24 Error stopping job: rpc error: code = Unknown desc = role "user" is not unauthorized to execute /job.JobManager/Stop
```